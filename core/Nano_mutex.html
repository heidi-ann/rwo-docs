<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link rel="previous" href="Mutex0.html">
<link rel="next" href="Never_returns.html">
<link rel="Up" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Array_permute" rel="Chapter" href="Array_permute.html">
<link title="Avltree" rel="Chapter" href="Avltree.html">
<link title="Backtrace" rel="Chapter" href="Backtrace.html">
<link title="Bag" rel="Chapter" href="Bag.html">
<link title="Bigbuffer" rel="Chapter" href="Bigbuffer.html">
<link title="Bigbuffer_internal" rel="Chapter" href="Bigbuffer_internal.html">
<link title="Bigstring" rel="Chapter" href="Bigstring.html">
<link title="Bigstring_marshal" rel="Chapter" href="Bigstring_marshal.html">
<link title="Bigsubstring" rel="Chapter" href="Bigsubstring.html">
<link title="Binable" rel="Chapter" href="Binable.html">
<link title="Binable0" rel="Chapter" href="Binable0.html">
<link title="Binary_packing" rel="Chapter" href="Binary_packing.html">
<link title="Blang" rel="Chapter" href="Blang.html">
<link title="Bool" rel="Chapter" href="Bool.html">
<link title="Bounded_int_table" rel="Chapter" href="Bounded_int_table.html">
<link title="Bucket" rel="Chapter" href="Bucket.html">
<link title="Byte_units" rel="Chapter" href="Byte_units.html">
<link title="Caml" rel="Chapter" href="Caml.html">
<link title="Command" rel="Chapter" href="Command.html">
<link title="Common" rel="Chapter" href="Common.html">
<link title="Commutative_group" rel="Chapter" href="Commutative_group.html">
<link title="Comparable" rel="Chapter" href="Comparable.html">
<link title="Comparable_intf" rel="Chapter" href="Comparable_intf.html">
<link title="Comparator" rel="Chapter" href="Comparator.html">
<link title="Constrained_float" rel="Chapter" href="Constrained_float.html">
<link title="Container" rel="Chapter" href="Container.html">
<link title="Core_arg" rel="Chapter" href="Core_arg.html">
<link title="Core_array" rel="Chapter" href="Core_array.html">
<link title="Core_bin_prot" rel="Chapter" href="Core_bin_prot.html">
<link title="Core_char" rel="Chapter" href="Core_char.html">
<link title="Core_condition" rel="Chapter" href="Core_condition.html">
<link title="Core_field" rel="Chapter" href="Core_field.html">
<link title="Core_filename" rel="Chapter" href="Core_filename.html">
<link title="Core_gc" rel="Chapter" href="Core_gc.html">
<link title="Core_hashtbl" rel="Chapter" href="Core_hashtbl.html">
<link title="Core_hashtbl_intf" rel="Chapter" href="Core_hashtbl_intf.html">
<link title="Core_int" rel="Chapter" href="Core_int.html">
<link title="Core_int32" rel="Chapter" href="Core_int32.html">
<link title="Core_int63" rel="Chapter" href="Core_int63.html">
<link title="Core_int64" rel="Chapter" href="Core_int64.html">
<link title="Core_lazy" rel="Chapter" href="Core_lazy.html">
<link title="Core_list" rel="Chapter" href="Core_list.html">
<link title="Core_map" rel="Chapter" href="Core_map.html">
<link title="Core_map_intf" rel="Chapter" href="Core_map_intf.html">
<link title="Core_map_unit_tests" rel="Chapter" href="Core_map_unit_tests.html">
<link title="Core_mutex" rel="Chapter" href="Core_mutex.html">
<link title="Core_nativeint" rel="Chapter" href="Core_nativeint.html">
<link title="Core_printexc" rel="Chapter" href="Core_printexc.html">
<link title="Core_printf" rel="Chapter" href="Core_printf.html">
<link title="Core_queue" rel="Chapter" href="Core_queue.html">
<link title="Core_random" rel="Chapter" href="Core_random.html">
<link title="Core_set" rel="Chapter" href="Core_set.html">
<link title="Core_set_intf" rel="Chapter" href="Core_set_intf.html">
<link title="Core_set_unit_tests" rel="Chapter" href="Core_set_unit_tests.html">
<link title="Core_sexp" rel="Chapter" href="Core_sexp.html">
<link title="Core_stack" rel="Chapter" href="Core_stack.html">
<link title="Core_string" rel="Chapter" href="Core_string.html">
<link title="Core_sys" rel="Chapter" href="Core_sys.html">
<link title="Core_thread" rel="Chapter" href="Core_thread.html">
<link title="Core_unix" rel="Chapter" href="Core_unix.html">
<link title="Core_weak" rel="Chapter" href="Core_weak.html">
<link title="Crc" rel="Chapter" href="Crc.html">
<link title="Daemon" rel="Chapter" href="Daemon.html">
<link title="Date" rel="Chapter" href="Date.html">
<link title="Day_of_week" rel="Chapter" href="Day_of_week.html">
<link title="Dequeue" rel="Chapter" href="Dequeue.html">
<link title="Doubly_linked" rel="Chapter" href="Doubly_linked.html">
<link title="Equal" rel="Chapter" href="Equal.html">
<link title="Error" rel="Chapter" href="Error.html">
<link title="Exn" rel="Chapter" href="Exn.html">
<link title="Flags" rel="Chapter" href="Flags.html">
<link title="Flags_intf" rel="Chapter" href="Flags_intf.html">
<link title="Float" rel="Chapter" href="Float.html">
<link title="Floatable" rel="Chapter" href="Floatable.html">
<link title="Float_intf" rel="Chapter" href="Float_intf.html">
<link title="Float_robust_compare" rel="Chapter" href="Float_robust_compare.html">
<link title="Fn" rel="Chapter" href="Fn.html">
<link title="Force_once" rel="Chapter" href="Force_once.html">
<link title="Fqueue" rel="Chapter" href="Fqueue.html">
<link title="Hashable" rel="Chapter" href="Hashable.html">
<link title="Hash_heap" rel="Chapter" href="Hash_heap.html">
<link title="Hash_queue" rel="Chapter" href="Hash_queue.html">
<link title="Hash_set" rel="Chapter" href="Hash_set.html">
<link title="Hash_set_intf" rel="Chapter" href="Hash_set_intf.html">
<link title="Heap" rel="Chapter" href="Heap.html">
<link title="Heap_block" rel="Chapter" href="Heap_block.html">
<link title="Host_and_port" rel="Chapter" href="Host_and_port.html">
<link title="Identifiable" rel="Chapter" href="Identifiable.html">
<link title="In_channel" rel="Chapter" href="In_channel.html">
<link title="Info" rel="Chapter" href="Info.html">
<link title="Intable" rel="Chapter" href="Intable.html">
<link title="Int_conversions" rel="Chapter" href="Int_conversions.html">
<link title="Interfaces" rel="Chapter" href="Interfaces.html">
<link title="Interned_string" rel="Chapter" href="Interned_string.html">
<link title="Interval" rel="Chapter" href="Interval.html">
<link title="Interval_intf" rel="Chapter" href="Interval_intf.html">
<link title="Int_intf" rel="Chapter" href="Int_intf.html">
<link title="Int_math" rel="Chapter" href="Int_math.html">
<link title="Int_replace_polymorphic_compare" rel="Chapter" href="Int_replace_polymorphic_compare.html">
<link title="Int_set" rel="Chapter" href="Int_set.html">
<link title="Invariant" rel="Chapter" href="Invariant.html">
<link title="Iobuf" rel="Chapter" href="Iobuf.html">
<link title="Iobuf_debug" rel="Chapter" href="Iobuf_debug.html">
<link title="Iobuf_intf" rel="Chapter" href="Iobuf_intf.html">
<link title="Iobuf_tests" rel="Chapter" href="Iobuf_tests.html">
<link title="Linux_ext" rel="Chapter" href="Linux_ext.html">
<link title="Lock_file" rel="Chapter" href="Lock_file.html">
<link title="Make_substring" rel="Chapter" href="Make_substring.html">
<link title="Memo" rel="Chapter" href="Memo.html">
<link title="Monad" rel="Chapter" href="Monad.html">
<link title="Month" rel="Chapter" href="Month.html">
<link title="Mutex0" rel="Chapter" href="Mutex0.html">
<link title="Nano_mutex" rel="Chapter" href="Nano_mutex.html">
<link title="Never_returns" rel="Chapter" href="Never_returns.html">
<link title="No_polymorphic_compare" rel="Chapter" href="No_polymorphic_compare.html">
<link title="Nothing" rel="Chapter" href="Nothing.html">
<link title="Nothing0" rel="Chapter" href="Nothing0.html">
<link title="Ofday" rel="Chapter" href="Ofday.html">
<link title="Only_in_test" rel="Chapter" href="Only_in_test.html">
<link title="Option" rel="Chapter" href="Option.html">
<link title="Ordered_collection_common" rel="Chapter" href="Ordered_collection_common.html">
<link title="Ordering" rel="Chapter" href="Ordering.html">
<link title="Or_error" rel="Chapter" href="Or_error.html">
<link title="Out_channel" rel="Chapter" href="Out_channel.html">
<link title="Pid" rel="Chapter" href="Pid.html">
<link title="Piecewise_linear" rel="Chapter" href="Piecewise_linear.html">
<link title="Piecewise_linear_intf" rel="Chapter" href="Piecewise_linear_intf.html">
<link title="Polymorphic_compare" rel="Chapter" href="Polymorphic_compare.html">
<link title="Polymorphic_compare_intf" rel="Chapter" href="Polymorphic_compare_intf.html">
<link title="Pretty_printer" rel="Chapter" href="Pretty_printer.html">
<link title="Process_env" rel="Chapter" href="Process_env.html">
<link title="Quickcheck" rel="Chapter" href="Quickcheck.html">
<link title="Ref" rel="Chapter" href="Ref.html">
<link title="Result" rel="Chapter" href="Result.html">
<link title="Robustly_comparable" rel="Chapter" href="Robustly_comparable.html">
<link title="Set_once" rel="Chapter" href="Set_once.html">
<link title="Sexpable" rel="Chapter" href="Sexpable.html">
<link title="Signal" rel="Chapter" href="Signal.html">
<link title="Source_code_position" rel="Chapter" href="Source_code_position.html">
<link title="Source_code_position0" rel="Chapter" href="Source_code_position0.html">
<link title="Span" rel="Chapter" href="Span.html">
<link title="Squeue" rel="Chapter" href="Squeue.html">
<link title="Stable" rel="Chapter" href="Stable.html">
<link title="Stable_containers" rel="Chapter" href="Stable_containers.html">
<link title="Stable_internal" rel="Chapter" href="Stable_internal.html">
<link title="Stable_unit_test" rel="Chapter" href="Stable_unit_test.html">
<link title="Stable_unit_test_intf" rel="Chapter" href="Stable_unit_test_intf.html">
<link title="Staged" rel="Chapter" href="Staged.html">
<link title="Std" rel="Chapter" href="Std.html">
<link title="Std_common" rel="Chapter" href="Std_common.html">
<link title="Std_kernel" rel="Chapter" href="Std_kernel.html">
<link title="Std_internal" rel="Chapter" href="Std_internal.html">
<link title="Stringable" rel="Chapter" href="Stringable.html">
<link title="String_id" rel="Chapter" href="String_id.html">
<link title="Substring" rel="Chapter" href="Substring.html">
<link title="Substring_intf" rel="Chapter" href="Substring_intf.html">
<link title="T" rel="Chapter" href="T.html">
<link title="Thread_safe_queue" rel="Chapter" href="Thread_safe_queue.html">
<link title="Time" rel="Chapter" href="Time.html">
<link title="Time_internal" rel="Chapter" href="Time_internal.html">
<link title="Timer" rel="Chapter" href="Timer.html">
<link title="Timing_wheel" rel="Chapter" href="Timing_wheel.html">
<link title="Timing_wheel_intf" rel="Chapter" href="Timing_wheel_intf.html">
<link title="Timing_wheel_unit_tests" rel="Chapter" href="Timing_wheel_unit_tests.html">
<link title="Tuple" rel="Chapter" href="Tuple.html">
<link title="Type_equal" rel="Chapter" href="Type_equal.html">
<link title="Union_find" rel="Chapter" href="Union_find.html">
<link title="Unique_id" rel="Chapter" href="Unique_id.html">
<link title="Unique_id_intf" rel="Chapter" href="Unique_id_intf.html">
<link title="Unit" rel="Chapter" href="Unit.html">
<link title="Univ" rel="Chapter" href="Univ.html">
<link title="Univ_map" rel="Chapter" href="Univ_map.html">
<link title="Unpack_buffer" rel="Chapter" href="Unpack_buffer.html">
<link title="User_and_group" rel="Chapter" href="User_and_group.html">
<link title="Uuid" rel="Chapter" href="Uuid.html">
<link title="Validate" rel="Chapter" href="Validate.html">
<link title="With_return" rel="Chapter" href="With_return.html">
<link title="Word_size" rel="Chapter" href="Word_size.html">
<link title="Zone" rel="Chapter" href="Zone.html"><title>Nano_mutex</title>
</head>
<body>
<div class="navbar"><a class="pre" href="Mutex0.html" title="Mutex0">Previous</a>
&nbsp;<a class="up" href="index.html" title="Index">Up</a>
&nbsp;<a class="post" href="Never_returns.html" title="Never_returns">Next</a>
</div>
<h1>Module <a href="type_Nano_mutex.html">Nano_mutex</a></h1>
<pre><span class="keyword">module</span> Nano_mutex: <code class="code">sig</code> <a href="Nano_mutex.html">..</a> <code class="code">end</code></pre><div class="info">
A nano-mutex is a lightweight mutex that can be used only within a single OCaml
    runtime.
<p>

    <h1 id="1_Performance">Performance</h1>
    ===============
    Nano-mutexes are intended to be significantly cheaper than OS-level mutexes.  Creating
    a nano-mutex allocates a single OCaml record.  Locking and unlocking an uncontested
    nano-mutex take a handful of instructions.  Only if a nano-mutex is contested will it
    fall back to using an OS-level mutex.  If a nano-mutex becomes uncontested again, it
    will switch back to using an OCaml-only lock.
<p>

    Nano-mutexes can be faster than using OS-level mutexes because OCaml uses a global
    lock on the runtime, and requires all running OCaml code to hold the lock.  The OCaml
    compiler only allows thread switches at certain points, and we can use that fact to get
    the atomic test-and-set used in the core of our implementaion without needing any
    primitive locking, essentially because we're protected by the OCaml global lock.
<p>

    Here are some benchmarks comparing various mutexes available in OCaml:
<p>

    <pre class="verbatim">      |-------------------------------------------------------------|
      |                       Name | Run time | S. dev. | Allocated |
      |----------------------------+----------+---------+-----------+
      |          Caml.Mutex create |   247 ns |    0 ns |         3 |
      |     Caml.Mutex lock/unlock |    49 ns |    0 ns |         0 |
      |          <a href="../core/Mutex.html">Core.Mutex</a> create |   698 ns |    0 ns |         3 |
      |     <a href="../core/Mutex.html">Core.Mutex</a> lock/unlock |    49 ns |    0 ns |         0 |
      |          Nano_mutex create |    10 ns |    0 ns |         4 |
      |     Nano_mutex lock/unlock |    28 ns |    0 ns |         0 |
      |-------------------------------------------------------------|
   </pre>
<p>

    The benchmark code is in core/extended/lib_test/bench_nano_mutex.ml.
<p>

    <h1 id="1_Errorhandling">Error handling</h1>
    ==================
    For any mutex, there are design choices as to how to behave in certain situations:
<p>
<ul>
<li>recursive locking (when a thread locks a mutex it already has)</li>
<li>unlocking an unlocked mutex</li>
<li>unlocking a mutex held by another thread</li>
</ul>

    Here is a table comparing how the various mutexes behave:
<p>

    <pre class="verbatim">      |--------------------+------------+------------+------------+
      |                    | Caml.Mutex | <a href="../core/Mutex.html">Core.Mutex</a> | Nano_mutex |
      |--------------------+------------+------------+------------+
      | recursive lock     | undefined  | error      | error      |
      | unlocking unlocked | undefined  | error      | error      |
      | t1:lock  t2:unlock | undefined  | error      | error      |
      |--------------------+------------+------------+------------+
   </pre><br>
</div>
<hr width="100%">
<pre><span id="TYPEt"><span class="keyword">type</span> <code class="type"></code>t</span> </pre>

<pre><span id="VALinvariant"><span class="keyword">val</span> invariant</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> unit</code></pre><pre><span id="VALcreate"><span class="keyword">val</span> create</span> : <code class="type">unit -> <a href="Nano_mutex.html#TYPEt">t</a></code></pre><div class="info">
<code class="code">create ()</code> returns a new, unlocked mutex.<br>
</div>
<pre><span id="VALequal"><span class="keyword">val</span> equal</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> <a href="Nano_mutex.html#TYPEt">t</a> -> bool</code></pre><div class="info">
<code class="code">equal</code> is <code class="code">phys_equal</code><br>
</div>
<pre><span id="VALcurrent_thread_has_lock"><span class="keyword">val</span> current_thread_has_lock</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> bool</code></pre><div class="info">
<code class="code">current_thread_has_lock t</code> returns <code class="code">true</code> iff the current thread has <code class="code">t</code> locked.<br>
</div>
<pre><span id="VALlock"><span class="keyword">val</span> lock</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> unit <a href="../core_kernel/Or_error.html">Core_kernel.Std.Or_error</a>.t</code></pre><div class="info">
<code class="code">lock t</code> locks the mutex <code class="code">t</code>, blocking until it can be locked.  <code class="code">lock</code> immediately
    returns <code class="code">Error</code> if the current thread already holds <code class="code">t</code>.<br>
</div>
<pre><span id="VALlock_exn"><span class="keyword">val</span> lock_exn</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> unit</code></pre><pre><span id="VALtry_lock"><span class="keyword">val</span> try_lock</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> [ `Acquired | `Not_acquired ] <a href="../core_kernel/Or_error.html">Core_kernel.Std.Or_error</a>.t</code></pre><div class="info">
<code class="code">try_lock t</code> locks <code class="code">t</code> if it can immediately do so.  The result indicates whether
    <code class="code">try_lock</code> succeeded in acquiring the lock.  <code class="code">try_lock</code> returns <code class="code">Error</code> if the current
    thread already holds <code class="code">t</code>.<br>
</div>
<pre><span id="VALtry_lock_exn"><span class="keyword">val</span> try_lock_exn</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> [ `Acquired | `Not_acquired ]</code></pre><pre><span id="VALunlock"><span class="keyword">val</span> unlock</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> unit <a href="../core_kernel/Or_error.html">Core_kernel.Std.Or_error</a>.t</code></pre><div class="info">
<code class="code">unlock t</code> unlocks <code class="code">t</code>, if the current thread holds it.  <code class="code">unlock</code> returns <code class="code">Error</code> if
    the lock is not held by the calling thread.<br>
</div>
<pre><span id="VALunlock_exn"><span class="keyword">val</span> unlock_exn</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> unit</code></pre><pre><span id="VALcritical_section"><span class="keyword">val</span> critical_section</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> f:(unit -> 'a) -> 'a</code></pre><pre><span id="VALsexp_of_t"><span class="keyword">val</span> sexp_of_t</span> : <code class="type"><a href="Nano_mutex.html#TYPEt">t</a> -> <a href="../sexplib/Sexp.html">Sexplib.Sexp</a>.t</code></pre><br>
<code class="code">create ()</code> returns a new, unlocked mutex.<br>
<br>
<code class="code">equal</code> is <code class="code">phys_equal</code><br>
<br>
<code class="code">current_thread_has_lock t</code> returns <code class="code">true</code> iff the current thread has <code class="code">t</code> locked.<br>
<br>
<code class="code">lock t</code> locks the mutex <code class="code">t</code>, blocking until it can be locked.  <code class="code">lock</code> immediately
    returns <code class="code">Error</code> if the current thread already holds <code class="code">t</code>.<br>
<br>
<code class="code">try_lock t</code> locks <code class="code">t</code> if it can immediately do so.  The result indicates whether
    <code class="code">try_lock</code> succeeded in acquiring the lock.  <code class="code">try_lock</code> returns <code class="code">Error</code> if the current
    thread already holds <code class="code">t</code>.<br>
<br>
<code class="code">unlock t</code> unlocks <code class="code">t</code>, if the current thread holds it.  <code class="code">unlock</code> returns <code class="code">Error</code> if
    the lock is not held by the calling thread.<br>
</body></html>